services:
  # MySQL Database Service
  mysql:
    build:
      context: ./database
      dockerfile: Dockerfile
    container_name: mrp-db
    environment:
      MYSQL_ROOT_PASSWORD: toor
    ports:
      - "3307:3306"
    networks:
      - mrp-network
    healthcheck:
      test: ["CMD", "mariadb-admin", "ping", "-h", "localhost", "-u", "root", "-ptoor", "--silent"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 60s
    # No persistent volumes - fresh database on each startup
    # tmpfs optimized for MariaDB with explicit size and mode
    tmpfs:
      - /var/lib/mysql:rw,noexec,nosuid,size=512m
      - /tmp:rw,noexec,nosuid,size=64m

  # Web Dashboard and Document Generator Service
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: mrp-frontend
    depends_on:
      mysql:
        condition: service_healthy
    ports:
      - "5001:5000"
    environment:
      DB_HOST: ${DB_HOST}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_PORT: 3306
      FLASK_SECRET_KEY: ${FLASK_SECRET_KEY}
      COC_TEMPLATE_PATH: /app/templates/documents/COC Template.docx
      COC_OUTPUT_DIR: /app/CACHE
      PO_TEMPLATE_PATH: /app/templates/documents/PO Template.docx
      PO_OUTPUT_DIR: /app/CACHE
    volumes:
      # Mount source code for development hot-reloading
      - ./frontend:/app:rw
    working_dir: /app
    networks:
      - mrp-network

  # MRP Backend Service (QuickBooks Integration)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: mrp-backend
    depends_on:
      mysql:
        condition: service_healthy
    ports:
      - "5002:5002"
    environment:
      # Database connection environment variables
      DB_HOST: ${DB_HOST}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_PORT: 3306
      # QuickBooks environment variables
      QUICKBOOKS_CLIENT_ID: ${QUICKBOOKS_CLIENT_ID}
      QUICKBOOKS_CLIENT_SECRET: ${QUICKBOOKS_CLIENT_SECRET}
      QUICKBOOKS_SANDBOX_BASE_URL: ${QUICKBOOKS_SANDBOX_BASE_URL}
      QUICKBOOKS_COMPANY_ID: ${QUICKBOOKS_COMPANY_ID}
      PRODUCTION_URI: ${PRODUCTION_URI}
      SECRET_KEY: ${FLASK_SECRET_KEY}
    volumes:
      # Mount source code for development hot-reloading
      - ./backend:/app:rw
    working_dir: /app
    networks:
      - mrp-network

networks:
  mrp-network:
    driver: bridge

volumes:
  # Define named volumes if needed for persistent data
  # (Currently not used since we want fresh DB each time)
  output-data:
    driver: local
