services:
  # MySQL Database Service
  mysql:
    image: mysql:8.0
    container_name: amc-mrp-db
    environment:
      MYSQL_ROOT_PASSWORD: toor
      # Database will be created by DDL.sql script
      # MYSQL_DATABASE: amcmrp  
      # MYSQL_USER: amc
      # MYSQL_PASSWORD: Workbench.lavender.chrome
    ports:
      - "3307:3306"
    volumes:
      # Mount SQL initialization scripts
      - ./mrp-db/DDL.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
      - ./mrp-db/test_data/testdata.sql:/docker-entrypoint-initdb.d/02-data.sql:ro
    networks:
      - amc-mrp-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-ptoor"]
      timeout: 20s
      retries: 10
      interval: 10s
      start_period: 40s
    # No persistent volumes - fresh database on each startup
    tmpfs:
      - /var/lib/mysql

  # Python Application Service
  gen-app:
    image: python:3.11-slim
    container_name: amc-mrp-generator
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      # Database connection environment variables
      DB_HOST: ${DB_HOST}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_PORT: 3306
      # COC Generator specific environment variables
      COC_TEMPLATE_PATH: /app/templates
      COC_OUTPUT_DIR: /app/CACHE
    volumes:
      # Mount source code for development
      - ./mrp-filegen/src:/app/src:ro
      # Mount output directory for generated PDFs
      - ./mrp-filegen/output:/app/CACHE:rw
      # Mount templates
      - ./mrp-filegen/file_templates:/app/templates:ro
      # Mount requirements.txt for installation
      - ./mrp-filegen/requirements.txt:/app/requirements.txt:ro
    working_dir: /app
    networks:
      - amc-mrp-network
    # Install dependencies and keep container running
    command: |
      bash -c "
        apt-get update && 
        apt-get install -y pandoc texlive-xetex texlive-fonts-recommended texlive-plain-generic libreoffice-writer --no-install-recommends && 
        rm -rf /var/lib/apt/lists/* &&
        pip install --no-cache-dir -r /app/requirements.txt && 
        mkdir -p /app/output &&
        echo 'Environment ready! Dependencies installed (including LibreOffice).' &&
        tail -f /dev/null
      "

  # Web Dashboard Service
  web-app:
    image: python:3.11-slim
    container_name: amc-mrp-web
    depends_on:
      mysql:
        condition: service_healthy
    ports:
      - "5001:5000"
    environment:
      DB_HOST: ${DB_HOST}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_PORT: 3306
      FLASK_SECRET_KEY: ${FLASK_SECRET_KEY}
      COC_TEMPLATE_PATH: /app/file_templates/COC Template.docx
      COC_OUTPUT_DIR: /app/CACHE
      PO_TEMPLATE_PATH: /app/file_templates/PO Template.docx
      PO_OUTPUT_DIR: /app/CACHE
    volumes:
      - ./mrp-webapp:/app/web:rw
      - ./mrp-webapp/CACHE:/app/CACHE:rw
      - ./mrp-filegen/file_templates:/app/file_templates:ro
      - ./mrp-filegen/src:/app/generators:ro
    working_dir: /app/
    networks:
      - amc-mrp-network
    command: |
      bash -c "
        echo 'Setting up web dashboard...' &&
        apt-get update && 
        apt-get install -y pandoc texlive-xetex texlive-fonts-recommended texlive-plain-generic libreoffice-writer --no-install-recommends && 
        rm -rf /var/lib/apt/lists/* &&
        pip install --no-cache-dir -r /app/web/requirements.txt &&
        echo 'Waiting for database to be ready...' &&
        sleep 20 &&
        echo 'Starting web dashboard...' &&
        echo 'Dashboard will be available at: http://localhost:5001' &&
        python run.py
      "

networks:
  amc-mrp-network:
    driver: bridge

volumes:
  # Define named volumes if needed for persistent data
  # (Currently not used since we want fresh DB each time)
  output-data:
    driver: local
