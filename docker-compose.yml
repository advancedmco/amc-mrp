services:
  # MySQL Database Service
  mysql:
    image: mysql:8.0
    container_name: amc-mrp-mysql
    environment:
      MYSQL_ROOT_PASSWORD: toor
      # Database will be created by DDL.sql script
      # MYSQL_DATABASE: amcmrp  
      # MYSQL_USER: amc
      # MYSQL_PASSWORD: Workbench.lavender.chrome
    ports:
      - "3307:3306"
    volumes:
      # Mount SQL initialization scripts
      - ./WORKING/DDL.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
      - ./WORKING/testdata.sql:/docker-entrypoint-initdb.d/02-data.sql:ro
    networks:
      - amc-mrp-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-ptoor"]
      timeout: 20s
      retries: 10
      interval: 10s
      start_period: 40s
    # No persistent volumes - fresh database on each startup
    tmpfs:
      - /var/lib/mysql

  # Python Application Service
  python-app:
    image: python:3.11-slim
    container_name: amc-mrp-python
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      # Database connection environment variables
      DB_HOST: mysql
      DB_NAME: amcmrp
      DB_USER: amc
      DB_PASSWORD: Workbench.lavender.chrome
      DB_PORT: 3306
      # COC Generator specific environment variables
      COC_TEMPLATE_PATH: /app/DevAssets/COC Template.docx
      COC_OUTPUT_DIR: /app/output
    volumes:
      # Mount source code for development
      - ./WORKING:/app/WORKING:rw
      - ./DevAssets:/app/DevAssets:ro
      # Mount output directory for generated PDFs
      - ./output:/app/output:rw
      # Mount templates
      - ./DevAssets/COC Template.docx:/app/DevAssets/COC Template.docx:ro
      # Mount requirements.txt for installation
      - ./DevAssets/pythondocker/requirements.txt:/app/requirements.txt:ro
    working_dir: /app/WORKING
    networks:
      - amc-mrp-network
    # Install dependencies and keep container running
    command: |
      bash -c "
        apt-get update && 
        apt-get install -y pandoc texlive-xetex texlive-fonts-recommended texlive-plain-generic libreoffice-writer --no-install-recommends && 
        rm -rf /var/lib/apt/lists/* &&
        pip install --no-cache-dir -r /app/requirements.txt && 
        mkdir -p /app/output &&
        echo 'Environment ready! Dependencies installed (including LibreOffice).' &&
        tail -f /dev/null
      "

  # Web Dashboard Service
  web-app:
    image: python:3.11-slim
    container_name: amc-mrp-web
    depends_on:
      mysql:
        condition: service_healthy
    ports:
      - "5000:5000"
    environment:
      DB_HOST: mysql
      DB_NAME: amcmrp
      DB_USER: amc
      DB_PASSWORD: Workbench.lavender.chrome
      DB_PORT: 3306
      COC_TEMPLATE_PATH: /app/DevAssets/COC Template.docx
      COC_OUTPUT_DIR: /app/output
      PO_TEMPLATE_PATH: /app/DevAssets/PO Template.docx
      PO_OUTPUT_DIR: /app/output
    volumes:
      - ./web:/app/web:rw
      - ./WORKING:/app/WORKING:rw
      - ./DevAssets:/app/DevAssets:ro
      - ./output:/app/output:rw
    working_dir: /app/web
    networks:
      - amc-mrp-network
    command: |
      bash -c "
        echo 'Setting up web dashboard...' &&
        apt-get update && 
        apt-get install -y pandoc texlive-xetex texlive-fonts-recommended texlive-plain-generic libreoffice-writer --no-install-recommends && 
        rm -rf /var/lib/apt/lists/* &&
        pip install --no-cache-dir -r /app/DevAssets/webappdocker/requirements.txt &&
        echo 'Waiting for database to be ready...' &&
        sleep 20 &&
        echo 'Starting web dashboard on port 5000...' &&
        echo 'Dashboard will be available at: http://localhost:5000' &&
        python run.py
      "

networks:
  amc-mrp-network:
    driver: bridge

volumes:
  # Define named volumes if needed for persistent data
  # (Currently not used since we want fresh DB each time)
  output-data:
    driver: local
