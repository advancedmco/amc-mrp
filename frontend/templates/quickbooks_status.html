{% extends "base.html" %}

{% block title %}QuickBooks Connection - Advanced Machine Co.{% endblock %}

{% block extra_css %}
<style>
    .status-card {
        border-left: 4px solid #6c757d;
        transition: all 0.3s;
    }
    .status-card.connected {
        border-left-color: #28a745;
    }
    .status-card.warning {
        border-left-color: #ffc107;
    }
    .status-card.error {
        border-left-color: #dc3545;
    }
    .info-row {
        padding: 0.75rem 0;
        border-bottom: 1px solid #e9ecef;
    }
    .info-row:last-child {
        border-bottom: none;
    }
    .info-label {
        font-weight: 600;
        color: #6c757d;
        min-width: 200px;
    }
    .info-value {
        color: #212529;
        font-family: 'Courier New', monospace;
    }
    .sync-stats {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    .stat-box {
        text-align: center;
        padding: 1rem;
    }
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
    }
    .stat-label {
        font-size: 0.875rem;
        opacity: 0.9;
    }
    .connect-button {
        font-size: 1.25rem;
        padding: 1rem 2rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="section-header d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-0">
                    <i class="bi bi-cloud-arrow-up me-2"></i>
                    QuickBooks Connection
                </h1>
                <p class="mb-0 mt-2">Manage your QuickBooks Online integration</p>
            </div>
            <a href="/" class="btn btn-outline-light">
                <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
            </a>
        </div>
    </div>
</div>

<!-- Connection Status Card -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card status-card" id="statusCard">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h4 class="mb-3">
                            <i class="bi bi-activity me-2" id="statusIcon"></i>
                            Connection Status
                        </h4>
                        <div class="d-flex align-items-center mb-3">
                            <span class="badge me-2" id="statusBadge" style="font-size: 1rem;">Loading...</span>
                            <span class="text-muted" id="statusMessage"></span>
                        </div>
                        <div id="connectionActions">
                            <!-- Actions will be inserted here -->
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <div id="lastSyncInfo">
                            <!-- Last sync info will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sync Statistics -->
<div class="row mb-4" id="syncStatsSection" style="display: none;">
    <div class="col-12">
        <div class="card sync-stats">
            <div class="card-body">
                <h5 class="mb-3">Synced Data Statistics</h5>
                <div class="row">
                    <div class="col-md-3">
                        <div class="stat-box">
                            <div class="stat-number" id="statCustomers">0</div>
                            <div class="stat-label">Customers</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-box">
                            <div class="stat-number" id="statVendors">0</div>
                            <div class="stat-label">Vendors</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-box">
                            <div class="stat-number" id="statItems">0</div>
                            <div class="stat-label">Items</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-box">
                            <div class="stat-number" id="statInvoices">0</div>
                            <div class="stat-label">Invoices</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Configuration Details -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-gear me-2"></i>
                    Configuration
                </h5>
            </div>
            <div class="card-body">
                <div id="configInfo">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    Setup Instructions
                </h5>
            </div>
            <div class="card-body">
                <ol class="mb-0">
                    <li class="mb-2">
                        <strong>Create QuickBooks App:</strong> Go to
                        <a href="https://developer.intuit.com/app/developer/qbo/docs/get-started" target="_blank">
                            QuickBooks Developer Portal
                        </a>
                    </li>
                    <li class="mb-2">
                        <strong>Get Credentials:</strong> Create an app and copy your Client ID and Client Secret
                    </li>
                    <li class="mb-2">
                        <strong>Set Redirect URI:</strong> In your QB app settings, add this redirect URI:
                        <code id="redirectUriDisplay" class="d-block mt-1 p-2 bg-light">Loading...</code>
                    </li>
                    <li class="mb-2">
                        <strong>Configure Environment:</strong> Add credentials to your <code>.env</code> file
                    </li>
                    <li class="mb-2">
                        <strong>Connect:</strong> Click the "Connect to QuickBooks" button above
                    </li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Test Connection -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-wrench me-2"></i>
                    Advanced Tools
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <button class="btn btn-primary w-100" onclick="testConnection()">
                            <i class="bi bi-plug me-2"></i>Test Connection
                        </button>
                    </div>
                    <div class="col-md-4 mb-3">
                        <button class="btn btn-info w-100" onclick="refreshCache()">
                            <i class="bi bi-arrow-repeat me-2"></i>Refresh Data
                        </button>
                    </div>
                    <div class="col-md-4 mb-3">
                        <button class="btn btn-secondary w-100" onclick="viewTokens()">
                            <i class="bi bi-key me-2"></i>View Token Info
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Token Info Modal -->
<div class="modal fade" id="tokenModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Token Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="tokenModalContent">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let statusData = null;
let configData = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadStatus();
    loadConfig();
});

// Load QuickBooks status
function loadStatus() {
    fetch('/api/qb/sync_status')
        .then(response => response.json())
        .then(data => {
            statusData = data;
            updateStatusDisplay(data);
        })
        .catch(error => {
            console.error('Error loading status:', error);
            showError('Failed to load QuickBooks status');
        });
}

// Load configuration
function loadConfig() {
    fetch('/api/qb/config')
        .then(response => response.json())
        .then(data => {
            configData = data;
            updateConfigDisplay(data);
        })
        .catch(error => {
            console.error('Error loading config:', error);
        });
}

// Update status display
function updateStatusDisplay(data) {
    const statusCard = document.getElementById('statusCard');
    const statusBadge = document.getElementById('statusBadge');
    const statusMessage = document.getElementById('statusMessage');
    const statusIcon = document.getElementById('statusIcon');
    const connectionActions = document.getElementById('connectionActions');
    const lastSyncInfo = document.getElementById('lastSyncInfo');
    const syncStatsSection = document.getElementById('syncStatsSection');

    // Remove existing status classes
    statusCard.classList.remove('connected', 'warning', 'error');

    if (data.error) {
        statusCard.classList.add('error');
        statusBadge.className = 'badge bg-danger me-2';
        statusBadge.textContent = 'Offline';
        statusIcon.className = 'bi bi-x-circle text-danger me-2';
        statusMessage.textContent = 'Cannot connect to backend service';
        connectionActions.innerHTML = '<div class="alert alert-danger">Backend service is not available. Please check your Docker containers.</div>';
        return;
    }

    const status = data.connection_status;

    // Update stats
    document.getElementById('statCustomers').textContent = data.customers_count || 0;
    document.getElementById('statVendors').textContent = data.vendors_count || 0;
    document.getElementById('statItems').textContent = data.items_count || 0;
    document.getElementById('statInvoices').textContent = data.invoices_count || 0;

    switch(status) {
        case 'not_configured':
            statusCard.classList.add('warning');
            statusBadge.className = 'badge bg-warning me-2';
            statusBadge.textContent = 'Not Configured';
            statusIcon.className = 'bi bi-exclamation-triangle text-warning me-2';
            statusMessage.textContent = 'QuickBooks credentials are not configured';
            connectionActions.innerHTML = `
                <div class="alert alert-warning">
                    <strong>Action Required:</strong> Configure your QuickBooks credentials in the .env file
                </div>
                <div class="mb-2">Required environment variables:</div>
                <ul>
                    <li><code>QUICKBOOKS_CLIENT_ID</code></li>
                    <li><code>QUICKBOOKS_CLIENT_SECRET</code></li>
                    <li><code>QB_REDIRECT_URI</code></li>
                </ul>
            `;
            break;

        case 'not_authenticated':
            statusCard.classList.add('error');
            statusBadge.className = 'badge bg-danger me-2';
            statusBadge.textContent = 'Not Connected';
            statusIcon.className = 'bi bi-shield-x text-danger me-2';
            statusMessage.textContent = 'QuickBooks authentication required';
            connectionActions.innerHTML = `
                <div class="alert alert-info">
                    <strong>Ready to Connect:</strong> Click the button below to authorize access to your QuickBooks account
                </div>
                <button class="btn btn-success connect-button" onclick="connectToQuickBooks()">
                    <i class="bi bi-shield-check me-2"></i>Connect to QuickBooks
                </button>
            `;
            break;

        case 'authenticated_no_data':
            statusCard.classList.add('warning');
            statusBadge.className = 'badge bg-warning me-2';
            statusBadge.textContent = 'Authenticated - No Data';
            statusIcon.className = 'bi bi-hourglass-split text-warning me-2';
            statusMessage.textContent = 'Connected but no data has been synced yet';
            connectionActions.innerHTML = `
                <div class="alert alert-info">
                    <strong>Syncing...</strong> Data sync is in progress or scheduled
                </div>
                <button class="btn btn-primary" onclick="refreshCache()">
                    <i class="bi bi-arrow-repeat me-2"></i>Trigger Sync Now
                </button>
            `;
            break;

        case 'connected':
            statusCard.classList.add('connected');
            statusBadge.className = 'badge bg-success me-2';
            statusBadge.textContent = 'Connected';
            statusIcon.className = 'bi bi-check-circle text-success me-2';
            statusMessage.textContent = 'QuickBooks is connected and syncing';
            syncStatsSection.style.display = 'block';

            if (data.last_updated) {
                const lastUpdate = new Date(data.last_updated);
                const now = new Date();
                const minutesAgo = Math.floor((now - lastUpdate) / 60000);

                let timeText;
                if (minutesAgo < 1) {
                    timeText = 'just now';
                } else if (minutesAgo < 60) {
                    timeText = `${minutesAgo} minute${minutesAgo !== 1 ? 's' : ''} ago`;
                } else {
                    const hoursAgo = Math.floor(minutesAgo / 60);
                    timeText = `${hoursAgo} hour${hoursAgo !== 1 ? 's' : ''} ago`;
                }

                lastSyncInfo.innerHTML = `
                    <div class="text-muted">Last synced</div>
                    <div class="h5 mb-0">${timeText}</div>
                    <div class="small text-muted">${lastUpdate.toLocaleString()}</div>
                `;
            } else {
                lastSyncInfo.innerHTML = '<div class="text-muted">Never synced</div>';
            }

            connectionActions.innerHTML = `
                <button class="btn btn-primary" onclick="refreshCache()">
                    <i class="bi bi-arrow-repeat me-2"></i>Sync Now
                </button>
                <button class="btn btn-outline-secondary ms-2" onclick="disconnectQuickBooks()">
                    <i class="bi bi-x-circle me-2"></i>Disconnect
                </button>
            `;
            break;

        default:
            statusBadge.className = 'badge bg-secondary me-2';
            statusBadge.textContent = 'Unknown';
            statusMessage.textContent = 'Status unknown';
    }
}

// Update config display
function updateConfigDisplay(data) {
    const configInfo = document.getElementById('configInfo');
    const redirectUriDisplay = document.getElementById('redirectUriDisplay');

    if (data.error) {
        configInfo.innerHTML = '<div class="alert alert-danger">Failed to load configuration</div>';
        return;
    }

    const redirectUri = data.redirect_uri || 'Not configured';
    redirectUriDisplay.textContent = redirectUri;

    configInfo.innerHTML = `
        <div class="info-row d-flex">
            <div class="info-label">Environment:</div>
            <div class="info-value ms-auto">${data.environment || 'sandbox'}</div>
        </div>
        <div class="info-row d-flex">
            <div class="info-label">Client ID:</div>
            <div class="info-value ms-auto">${data.client_id || 'Not set'}</div>
        </div>
        <div class="info-row d-flex">
            <div class="info-label">Company ID:</div>
            <div class="info-value ms-auto">${data.company_id || 'Not set'}</div>
        </div>
        <div class="info-row d-flex">
            <div class="info-label">Base URL:</div>
            <div class="info-value ms-auto small">${data.base_url || 'Not set'}</div>
        </div>
        <div class="info-row d-flex">
            <div class="info-label">Redirect URI:</div>
            <div class="info-value ms-auto small">${redirectUri}</div>
        </div>
        <div class="info-row d-flex">
            <div class="info-label">Has Access Token:</div>
            <div class="info-value ms-auto">
                ${data.has_access_token ? '<i class="bi bi-check-circle text-success"></i> Yes' : '<i class="bi bi-x-circle text-danger"></i> No'}
            </div>
        </div>
        <div class="info-row d-flex">
            <div class="info-label">Has Refresh Token:</div>
            <div class="info-value ms-auto">
                ${data.has_refresh_token ? '<i class="bi bi-check-circle text-success"></i> Yes' : '<i class="bi bi-x-circle text-danger"></i> No'}
            </div>
        </div>
        <div class="info-row d-flex">
            <div class="info-label">Token Expires:</div>
            <div class="info-value ms-auto">${data.token_expires_at ? new Date(data.token_expires_at).toLocaleString() : 'N/A'}</div>
        </div>
    `;
}

// Connect to QuickBooks
function connectToQuickBooks() {
    showLoading('Redirecting to QuickBooks...');

    fetch('/api/qb/auth_url')
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.auth_url) {
                window.location.href = data.auth_url;
            } else {
                showAlert('Failed to generate authorization URL: ' + (data.error || 'Unknown error'), 'danger');
            }
        })
        .catch(error => {
            hideLoading();
            showAlert('Error: ' + error.message, 'danger');
        });
}

// Disconnect from QuickBooks
function disconnectQuickBooks() {
    if (!confirm('Are you sure you want to disconnect from QuickBooks? You will need to re-authorize to sync data again.')) {
        return;
    }

    showLoading('Disconnecting...');

    fetch('/api/qb/disconnect', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showAlert('Disconnected from QuickBooks', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showAlert('Failed to disconnect: ' + (data.error || 'Unknown error'), 'danger');
            }
        })
        .catch(error => {
            hideLoading();
            showAlert('Error: ' + error.message, 'danger');
        });
}

// Test connection
function testConnection() {
    showLoading('Testing connection...');

    fetch('/api/qb/test')
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showAlert('Connection test successful! ' + data.message, 'success');
            } else {
                showAlert('Connection test failed: ' + (data.error || 'Unknown error'), 'danger');
            }
        })
        .catch(error => {
            hideLoading();
            showAlert('Error: ' + error.message, 'danger');
        });
}

// Refresh cache
function refreshCache() {
    showLoading('Syncing data from QuickBooks...');

    fetch('/api/qb/refresh', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.error) {
                showAlert('Sync failed: ' + data.error, 'danger');
            } else {
                showAlert('Data synced successfully!', 'success');
                setTimeout(() => loadStatus(), 1000);
            }
        })
        .catch(error => {
            hideLoading();
            showAlert('Error: ' + error.message, 'danger');
        });
}

// View tokens
function viewTokens() {
    showLoading('Loading token information...');

    fetch('/api/qb/config')
        .then(response => response.json())
        .then(data => {
            hideLoading();

            const content = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    Token information is shown for debugging purposes only. Never share these values.
                </div>
                <table class="table">
                    <tr>
                        <td><strong>Has Access Token:</strong></td>
                        <td>${data.has_access_token ? 'Yes' : 'No'}</td>
                    </tr>
                    <tr>
                        <td><strong>Has Refresh Token:</strong></td>
                        <td>${data.has_refresh_token ? 'Yes' : 'No'}</td>
                    </tr>
                    <tr>
                        <td><strong>Token Expires:</strong></td>
                        <td>${data.token_expires_at ? new Date(data.token_expires_at).toLocaleString() : 'N/A'}</td>
                    </tr>
                    <tr>
                        <td><strong>Company ID:</strong></td>
                        <td>${data.company_id || 'Not set'}</td>
                    </tr>
                </table>
            `;

            document.getElementById('tokenModalContent').innerHTML = content;
            const modal = new bootstrap.Modal(document.getElementById('tokenModal'));
            modal.show();
        })
        .catch(error => {
            hideLoading();
            showAlert('Error: ' + error.message, 'danger');
        });
}

// Helper: Show error
function showError(message) {
    const statusCard = document.getElementById('statusCard');
    statusCard.innerHTML = `
        <div class="card-body">
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>
                ${message}
            </div>
        </div>
    `;
}
</script>
{% endblock %}
