{% extends "base.html" %}

{% block title %}MRP Dashboard - Advanced Machine Co.{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="section-header">
            <h1 class="mb-0">
                <i class="bi bi-speedometer2 me-2"></i>
                MRP Dashboard
            </h1>
            <p class="mb-0 mt-2">Manufacturing Resource Planning System</p>
        </div>
    </div>
</div>

<!-- Section 1: Live Orders -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-play-circle me-2"></i>
                    Live Orders
                </h5>
                <span class="badge bg-light text-dark">{{ live_orders|length }} orders</span>
            </div>
            <div class="card-body p-0">
                {% if live_orders %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Work Order</th>
                                <th>Customer</th>
                                <th>Part</th>
                                <th>Material</th>
                                <th>Quantity</th>
                                <th>Due Date</th>
                                <th>Status</th>
                                <th>Priority</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in live_orders %}
                            <tr>
                                <td>
                                    <strong>{{ order.WorkOrderNumber }}</strong>
                                    {% if order.CustomerPONumber %}
                                    <br><small class="text-muted">PO: {{ order.CustomerPONumber }}</small>
                                    {% endif %}
                                </td>
                                <td>{{ order.CustomerName }}</td>
                                <td>
                                    <strong>{{ order.PartNumber }}</strong>
                                    <br><small class="text-muted">{{ order.PartName }}</small>
                                </td>
                                <td>{{ order.Material or 'N/A' }}</td>
                                <td>
                                    {{ order.QuantityCompleted }}/{{ order.QuantityOrdered }}
                                    <br><small class="text-muted">
                                        {% set progress = (order.QuantityCompleted / order.QuantityOrdered * 100) if order.QuantityOrdered > 0 else 0 %}
                                        {{ "%.0f"|format(progress) }}% complete
                                    </small>
                                </td>
                                <td>
                                    {% if order.DueDate %}
                                        {{ order.DueDate.strftime('%m/%d/%Y') }}
                                        <br>
                                        {% if order.DaysUntilDue is not none %}
                                            {% if order.DaysUntilDue < 0 %}
                                                <small class="text-danger fw-bold">{{ order.DaysUntilDue|abs }} days overdue</small>
                                            {% elif order.DaysUntilDue <= 3 %}
                                                <small class="text-warning fw-bold">{{ order.DaysUntilDue }} days left</small>
                                            {% else %}
                                                <small class="text-success">{{ order.DaysUntilDue }} days left</small>
                                            {% endif %}
                                        {% endif %}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge {{ 'bg-warning' if order.Status == 'Pending Material' else 'bg-secondary' if order.Status == 'Idle' else 'bg-primary' if order.Status == 'On Machine' else 'bg-info' if order.Status == 'Secondary Operations' else 'bg-warning' if order.Status == 'Quality Control' else 'bg-success' }}">
                                        {{ order.Status }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge {{ 'bg-secondary' if order.Priority == 'Low' else 'bg-primary' if order.Priority == 'Normal' else 'bg-warning' if order.Priority == 'High' else 'bg-danger' }}">
                                        {{ order.Priority }}
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-primary" onclick="viewOrderDetails({{ order.WorkOrderID }})" title="View Details">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-success" onclick="showCreatePOModal({{ order.WorkOrderID }})" title="Create PO">
                                            <i class="bi bi-file-earmark-plus"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-inbox display-4 text-muted"></i>
                    <p class="text-muted mt-2">No live orders found</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Section 2: Recent Completed Orders -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-check-circle me-2"></i>
                    Recent Completed Orders
                </h5>
                <span class="badge bg-light text-dark">{{ recent_completed|length }} orders (last 30 days)</span>
            </div>
            <div class="card-body p-0">
                {% if recent_completed %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Work Order</th>
                                <th>Customer</th>
                                <th>Part</th>
                                <th>Quantity</th>
                                <th>Completed</th>
                                <th>Payment Status</th>
                                <th>COC Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in recent_completed %}
                            <tr>
                                <td>
                                    <strong>{{ order.WorkOrderNumber }}</strong>
                                    {% if order.CustomerPONumber %}
                                    <br><small class="text-muted">PO: {{ order.CustomerPONumber }}</small>
                                    {% endif %}
                                </td>
                                <td>{{ order.CustomerName }}</td>
                                <td>
                                    <strong>{{ order.PartNumber }}</strong>
                                    <br><small class="text-muted">{{ order.PartName }}</small>
                                </td>
                                <td>{{ order.QuantityCompleted }}</td>
                                <td>
                                    {% if order.CompletionDate %}
                                        {{ order.CompletionDate.strftime('%m/%d/%Y') }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle {{ 'text-danger' if order.PaymentStatus == 'Not Received' else 'text-warning' if order.PaymentStatus == 'In Progress' else 'text-success' }}" 
                                                type="button" data-bs-toggle="dropdown">
                                            {{ order.PaymentStatus or 'Not Received' }}
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item payment-status-btn" href="#" data-order-id="{{ order.WorkOrderID }}" data-status="Not Received">Not Received</a></li>
                                            <li><a class="dropdown-item payment-status-btn" href="#" data-order-id="{{ order.WorkOrderID }}" data-status="In Progress">In Progress</a></li>
                                            <li><a class="dropdown-item payment-status-btn" href="#" data-order-id="{{ order.WorkOrderID }}" data-status="Received">Received</a></li>
                                        </ul>
                                    </div>
                                </td>
                                <td>
                                    {% if order.CertificateNumber %}
                                        <span class="badge bg-success">Generated</span>
                                        <br><small class="text-muted">{{ order.CertificateNumber }}</small>
                                    {% else %}
                                        <span class="badge bg-warning">Pending</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-primary" onclick="viewOrderDetails({{ order.WorkOrderID }})" title="View Details">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        {% if not order.CertificateNumber %}
                                        <button type="button" class="btn btn-outline-success" onclick="generateCOC({{ order.WorkOrderID }})" title="Generate COC">
                                            <i class="bi bi-file-earmark-check"></i>
                                        </button>
                                        {% else %}
                                        <button type="button" class="btn btn-outline-info" onclick="downloadCOC('{{ order.COCPath }}')" title="Download COC">
                                            <i class="bi bi-download"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-inbox display-4 text-muted"></i>
                    <p class="text-muted mt-2">No recent completed orders found</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Section 3: Old Orders -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-archive me-2"></i>
                    Old Orders
                </h5>
                <span class="badge bg-light text-dark">{{ old_orders|length }} orders (older than 30 days)</span>
            </div>
            <div class="card-body p-0">
                {% if old_orders %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Work Order</th>
                                <th>Customer</th>
                                <th>Part</th>
                                <th>Quantity</th>
                                <th>Completed</th>
                                <th>Payment Status</th>
                                <th>COC Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in old_orders %}
                            <tr>
                                <td>
                                    <strong>{{ order.WorkOrderNumber }}</strong>
                                    {% if order.CustomerPONumber %}
                                    <br><small class="text-muted">PO: {{ order.CustomerPONumber }}</small>
                                    {% endif %}
                                </td>
                                <td>{{ order.CustomerName }}</td>
                                <td>
                                    <strong>{{ order.PartNumber }}</strong>
                                    <br><small class="text-muted">{{ order.PartName }}</small>
                                </td>
                                <td>{{ order.QuantityCompleted }}</td>
                                <td>
                                    {% if order.CompletionDate %}
                                        {{ order.CompletionDate.strftime('%m/%d/%Y') }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge {{ 'bg-danger' if order.PaymentStatus == 'Not Received' else 'bg-warning' if order.PaymentStatus == 'In Progress' else 'bg-success' }}">
                                        {{ order.PaymentStatus or 'Not Received' }}
                                    </span>
                                </td>
                                <td>
                                    {% if order.CertificateNumber %}
                                        <span class="badge bg-success">Generated</span>
                                        <br><small class="text-muted">{{ order.CertificateNumber }}</small>
                                    {% else %}
                                        <span class="badge bg-secondary">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-primary" onclick="viewOrderDetails({{ order.WorkOrderID }})" title="View Details">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        {% if order.COCPath %}
                                        <button type="button" class="btn btn-outline-info" onclick="downloadCOC('{{ order.COCPath }}')" title="Download COC">
                                            <i class="bi bi-download"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-inbox display-4 text-muted"></i>
                    <p class="text-muted mt-2">No old orders found</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Order Details Modal -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="orderDetailsContent">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<!-- Create PO Modal -->
<div class="modal fade" id="createPOModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Purchase Orders</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="createPOContent">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// View order details
function viewOrderDetails(workOrderId) {
    showLoading('Loading order details...');
    
    fetch(`/order_details/${workOrderId}`)
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.error) {
                showAlert(data.error, 'danger');
                return;
            }
            
            // Build order details HTML
            let html = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Order Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Work Order:</strong></td><td>${data.WorkOrderNumber}</td></tr>
                            <tr><td><strong>Customer:</strong></td><td>${data.CustomerName}</td></tr>
                            <tr><td><strong>Customer PO:</strong></td><td>${data.CustomerPONumber || 'N/A'}</td></tr>
                            <tr><td><strong>Status:</strong></td><td><span class="badge ${getStatusBadgeClass(data.Status)}">${data.Status}</span></td></tr>
                            <tr><td><strong>Priority:</strong></td><td><span class="badge ${data.Priority === 'High' ? 'bg-warning' : data.Priority === 'Urgent' ? 'bg-danger' : 'bg-primary'}">${data.Priority}</span></td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Part Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Part Number:</strong></td><td>${data.PartNumber}</td></tr>
                            <tr><td><strong>Part Name:</strong></td><td>${data.PartName}</td></tr>
                            <tr><td><strong>Material:</strong></td><td>${data.Material || 'N/A'}</td></tr>
                            <tr><td><strong>Drawing:</strong></td><td>${data.DrawingNumber || 'N/A'}</td></tr>
                            <tr><td><strong>Quantity:</strong></td><td>${data.QuantityCompleted}/${data.QuantityOrdered}</td></tr>
                        </table>
                    </div>
                </div>
            `;
            
            // Add BOM processes if available
            if (data.BOMProcesses && data.BOMProcesses.length > 0) {
                html += `
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>BOM Processes</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Type</th>
                                            <th>Process</th>
                                            <th>Vendor</th>
                                            <th>Quantity</th>
                                            <th>Cost</th>
                                            <th>Status</th>
                                            <th>Cert Required</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                
                data.BOMProcesses.forEach(process => {
                    html += `
                        <tr>
                            <td>${process.ProcessType}</td>
                            <td>${process.ProcessName}</td>
                            <td>${process.VendorName || 'N/A'}</td>
                            <td>${process.Quantity}</td>
                            <td>${formatCurrency(process.EstimatedCost)}</td>
                            <td><span class="badge ${process.Status === 'Pending' ? 'bg-warning' : process.Status === 'Ordered' ? 'bg-primary' : 'bg-success'}">${process.Status}</span></td>
                            <td>${process.CertificationRequired ? '<i class="bi bi-check-circle text-success"></i>' : '<i class="bi bi-x-circle text-muted"></i>'}</td>
                        </tr>
                    `;
                });
                
                html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('orderDetailsContent').innerHTML = html;
            const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
            modal.show();
        })
        .catch(error => {
            hideLoading();
            showAlert('Error loading order details: ' + error.message, 'danger');
        });
}

// Show create PO modal
function showCreatePOModal(workOrderId) {
    showLoading('Loading BOM processes...');
    
    fetch(`/order_details/${workOrderId}`)
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.error) {
                showAlert(data.error, 'danger');
                return;
            }
            
            if (!data.BOMProcesses || data.BOMProcesses.length === 0) {
                showAlert('No BOM processes found for this work order', 'warning');
                return;
            }
            
            // Filter processes that can have POs created
            const availableProcesses = data.BOMProcesses.filter(p => p.Status === 'Pending' && p.VendorName);
            
            if (availableProcesses.length === 0) {
                showAlert('No processes available for PO creation', 'warning');
                return;
            }
            
            let html = `
                <div class="mb-3">
                    <h6>Work Order: ${data.WorkOrderNumber} - ${data.PartName}</h6>
                    <p class="text-muted">Select processes to create purchase orders:</p>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Process</th>
                                <th>Vendor</th>
                                <th>Quantity</th>
                                <th>Est. Cost</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            availableProcesses.forEach(process => {
                html += `
                    <tr>
                        <td>
                            <strong>${process.ProcessName}</strong>
                            <br><small class="text-muted">${process.ProcessType}</small>
                        </td>
                        <td>${process.VendorName}</td>
                        <td>${process.Quantity}</td>
                        <td>${formatCurrency(process.EstimatedCost)}</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-success" onclick="createPO(${process.ProcessID})">
                                <i class="bi bi-file-earmark-plus me-1"></i>Create PO
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('createPOContent').innerHTML = html;
            const modal = new bootstrap.Modal(document.getElementById('createPOModal'));
            modal.show();
        })
        .catch(error => {
            hideLoading();
            showAlert('Error loading BOM processes: ' + error.message, 'danger');
        });
}

// Create PO
function createPO(processId) {
    showLoading('Creating purchase order...');
    
    fetch(`/create_po/${processId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showAlert(data.message, 'success');
            // Close modal and refresh page
            const modal = bootstrap.Modal.getInstance(document.getElementById('createPOModal'));
            modal.hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert(data.error || 'Failed to create PO', 'danger');
        }
    })
    .catch(error => {
        hideLoading();
        showAlert('Error creating PO: ' + error.message, 'danger');
    });
}

// Generate COC
function generateCOC(workOrderId) {
    showLoading('Generating Certificate of Completion...');
    
    fetch(`/generate_coc/${workOrderId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showAlert(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert(data.error || 'Failed to generate COC', 'danger');
        }
    })
    .catch(error => {
        hideLoading();
        showAlert('Error generating COC: ' + error.message, 'danger');
    });
}

// Update payment status
function updatePaymentStatus(workOrderId, status) {
    showLoading('Updating payment status...');
    
    fetch(`/update_payment/${workOrderId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            payment_status: status
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showAlert(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert(data.error || 'Failed to update payment status', 'danger');
        }
    })
    .catch(error => {
        hideLoading();
        showAlert('Error updating payment status: ' + error.message, 'danger');
    });
}

// Download COC
function downloadCOC(filePath) {
    if (!filePath) {
        showAlert('COC file not available', 'warning');
        return;
    }
    
    const filename = filePath.split('/').pop();
    window.open(`/download_pdf/${filename}`, '_blank');
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Payment status button event listeners
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('payment-status-btn')) {
            e.preventDefault();
            const orderId = e.target.getAttribute('data-order-id');
            const status = e.target.getAttribute('data-status');
            updatePaymentStatus(orderId, status);
        }
    });
});
</script>
{% endblock %}
